/*! TagSelect.js 2015-01-14 */
!function(a){function b(a){var b,c=0,d=a.ownerDocument||a.document,e=d.defaultView||d.parentWindow;if("undefined"!=typeof e.getSelection){if(b=e.getSelection(),b.rangeCount>0){var f=e.getSelection().getRangeAt(0),g=f.cloneRange();g.selectNodeContents(a),g.setEnd(f.endContainer,f.endOffset),c=g.toString().length}}else if((b=d.selection)&&"Control"!==b.type){var h=b.createRange(),i=d.body.createTextRange();i.moveToElementText(a),i.setEndPoint("EndToEnd",h),c=i.text.length}return c}var c="tagcomplete",d=38,e=40,f=[d,e],g=[37,39],h={ns:"tasg",returnKeys:[13,9],options:[],minChars:0,matchAll:!1},i=function(b,c){this.$el=b,this.options=a.extend({},h,c),this.o=this.options,this.isVisible=!1,this.beginOffset=-1,this.caretOffset=-1,this.$dd=a('<ul class="'+this.o.ns+'-dropdown"/>'),this.$dd.insertAfter(this.$el),this.bindEvents()};i.prototype.match=function(b){if(!b)return a.Deferred().reject();for(var c,d=a.Deferred(),e=RegExp.quote(b),f=new RegExp("^"+e,"i"),g=new RegExp(e,"i"),h=[],i=[],j=0;j<this.o.options.length;j++)c=this.o.options[j],c!==b&&(c.match(f)?h.push(c):this.o.matchAll&&c.match(g)&&i.push(c));return i=h.concat(i),i.length?d.resolve(i):d.reject(i)},i.prototype.select=function(){if(this.isVisible){for(var a=this.$dd.children(".active"),b=a.data("repl"),c=a.data("insert"),d=0;d<b.length;d++)document.execCommand("delete");document.execCommand("insertText",!1,c),this.hide()}},i.prototype.show=function(a){for(var b,c,d=new Array(a.length),e=this.caretOffset-this.beginOffset,f=0;f<a.length;f++)b=0===f?"active":"",c=a[f].substr(0,e),d.push('<li class="'+b+'" data-insert="'+a[f]+'" data-repl="'+c+'">'+a[f]+"</li>");this.$dd.html(d).css({left:this.$el.width()+1}).addClass("visible"),this.isVisible=!0},i.prototype.hide=function(){this.$dd.removeClass("visible"),this.isVisible=!1},i.prototype.setActive=function(a){var b=this.$dd.children(".active"),c=b[a]();c.length&&(b.removeClass("active"),c.addClass("active"))},i.prototype.setOptions=function(b){this.options=a.extend(this.options,b)},i.prototype.bindEvents=function(){this.$el.on({input:_.bind(this.onInput,this),keydown:_.bind(this.onKeydown,this),blur:_.bind(this.hide,this)})},i.prototype.onInput=function(){this.caretOffset=b(this.$el[0]);var a=this.$el.text();if(!(this.caretOffset<a.length&&a[this.caretOffset].match(/\w/))){this.beginOffset=0;for(var c=this.caretOffset-1;c>=0;c--)if(a[c].match(/\W/)){this.beginOffset=c+1;break}var d=this,e=a.substr(this.beginOffset,this.caretOffset-this.beginOffset);this.match(e).done(function(a){d.show(a)}).fail(function(){d.hide()})}},i.prototype.onKeydown=function(b){this.isVisible&&(a.inArray(b.which,this.o.returnKeys)>=0?(b.preventDefault(),b.stopImmediatePropagation(),this.select()):a.inArray(b.which,f)>=0?(b.preventDefault(),this.setActive(b.which===d?"prev":"next")):a.inArray(b.which,g)>=0&&this.hide())},a.fn[c]=function(b){var d=this.data(c);return b&&"object"!=typeof b?d?d[b].apply(d,Array.prototype.slice.call(arguments,1)):void a.error('Cannot call "'+b+'" - TagComplete not initialized.'):d||this.data(c,new i(this,b))}}(jQuery),function(){var a={autocorrect:"off",autocapitalize:"off",spellcheck:"false"},b='<% _.forEach(selected, function (fd) { %><span data-fd="<%- fd %>" class="tagselect-fd<%= options[fd] ? \'\' : \' invalid\' %>"><%- fd %></span><span class="tagselect-fd-separator">, </span><% }) %>',c=FTB.Component.extend({init:function(c){this.$el=c.$el||c.el,this.selected=c.selected||[],this.template=_.template(b),this.setOptions(c.options),this.$el.attr(a).prop("contenteditable",!0).addClass("tagselect"),_.isArray(this.options)&&(this.options=_.invert(this.options))},render:function(){return this.$el.html(this.trim(this.template(this)))},postRender:function(){this.$el.tagcomplete({options:_.keys(this.options)}),this.$el.on({blur:_.bind(this.update,this),keydown:function(a){91===a.which||a.metaKey?a.stopPropagation():13===a.which&&(a.preventDefault(),$(this).blur())}})},get:function(){return this.selected},set:function(a){this.selected=_.uniq(a),this.render()},setOptions:function(a){this.options=$.isArray(a)?_.invert(a):a||{},this.$el.data("tagcomplete")&&this.$el.tagcomplete().setOptions({options:_.keys(this.options)})},update:function(){var a=_.filter(this.$el.text().split(/\W+/)),b=!_.isEqual(a,this.selected);this.set(a),b&&this.validate()&&this.trigger("change")},validate:function(){for(var a,b=0;a=this.selected[b];b++)if(!this.options[a])return!1;return!0},trim:function(a){return a.replace(/\n\s*/gm,"")}});FTB.module("FTB.TagSelect",c)}();