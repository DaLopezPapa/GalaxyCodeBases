/*! TagSelect.js | FindTheBest, Inc. | 2015-01-16 */
!function(a,b){function c(a){var b,c=0,d=a.ownerDocument||a.document,e=d.defaultView||d.parentWindow;if("undefined"!=typeof e.getSelection){if(b=e.getSelection(),b.rangeCount>0){var f=e.getSelection().getRangeAt(0),g=f.cloneRange();g.selectNodeContents(a),g.setEnd(f.endContainer,f.endOffset),c=g.toString().length}}else if((b=d.selection)&&"Control"!==b.type){var h=b.createRange(),i=d.body.createTextRange();i.moveToElementText(a),i.setEndPoint("EndToEnd",h),c=i.text.length}return c}function d(a,b){a=a.jquery?a[0]:a,this.el=a,this.autocomplete=null,this.selected=b.selected||[],this.template=_.template(m),this.listeners={change:[]},this.setOptions(b.options),a.classList.add("tagselect"),_.forEach(l,function(b,c){a.setAttribute(c,b)}),this.render(),this.postRender()}b.window=a;var e=38,f=40,g=[e,f],h=[37,39],i=_.template('<li class="<%= ns %>-option<%= active ? " active" : "" %>" data-insert="<%- match %>"><%- match %></li>'),j={ns:"tasg",returnKeys:[13,9],options:[],minChars:0,matchAll:!1},k=function(a,b){this.el=a,this.options=_.merge({},j,b),this.o=this.options,this.isVisible=!1,this.beginOffset=-1,this.caretOffset=-1,this.dd=document.createElement("ul"),this.dd.classList.add(this.o.ns+"-dropdown"),this.el.insertAdjacentElement("afterend",this.dd),this.bindEvents()};k.prototype.match=function(a){if(!a)return[];for(var b,c=RegExp.quote(a),d=new RegExp("^"+c,"i"),e=new RegExp(c,"i"),f=[],g=[],h=0;h<this.o.options.length;h++)b=this.o.options[h],b!==a&&(b.match(d)?f.push(b):this.o.matchAll&&b.match(e)&&g.push(b));return f.concat(g)},k.prototype.select=function(a){if(this.isVisible){for(var b=this.caretOffset-this.beginOffset,c=a.getAttribute("data-insert"),d=0;b>d;d++)document.execCommand("delete");document.execCommand("insertText",!1,c)}},k.prototype.show=function(a){a=_.map(a,_.bind(function(a,b){return{ns:this.o.ns,active:0===b,match:a}},this)),this.dd.innerHTML=_.map(a,i).join(""),this.dd.style.left=this.el.offsetWidth+1+"px",this.dd.classList.add("visible"),this.isVisible=!0},k.prototype.hide=function(){this.dd.classList.remove("visible"),this.isVisible=!1},k.prototype.setActive=function(a){var b=this.dd.querySelector(".active"),c=b[a+"ElementSibling"];c&&(b.classList.remove("active"),c.classList.add("active"))},k.prototype.setOptions=function(a){this.options=_.merge(this.options,a)},k.prototype.bindEvents=function(){this.el.addEventListener("input",_.bind(this.onInput,this)),this.el.addEventListener("keydown",_.bind(this.onKeydown,this)),this.el.addEventListener("blur",_.bind(this.hide,this)),this.dd.addEventListener("mousedown",_.bind(function(a){a.target.classList.contains(this.o.ns+"-option")&&this.select(a.target)},this))},k.prototype.onInput=function(){this.caretOffset=c(this.el);var a=this.el.textContent;if(!(this.caretOffset<a.length&&a[this.caretOffset].match(/\w/))){this.beginOffset=0;for(var b=this.caretOffset-1;b>=0;b--)if(a[b].match(/\W/)){this.beginOffset=b+1;break}var d=a.substr(this.beginOffset,this.caretOffset-this.beginOffset),e=this.match(d);_.size(e)?this.show(e):this.hide()}},k.prototype.onKeydown=function(a){this.isVisible&&(_.contains(this.o.returnKeys,a.which)?(a.preventDefault(),a.stopImmediatePropagation(),this.select(this.dd.querySelector(".active")),this.hide()):_.contains(g,a.which)?(a.preventDefault(),this.setActive(a.which===e?"previous":"next")):_.contains(h,a.which)&&this.hide())};var l={autocorrect:"off",autocapitalize:"off",spellcheck:"false",contenteditable:!0},m='<% _.forEach(selected, function (fd) { %><span data-fd="<%- fd %>" class="tagselect-fd<%= options[fd] ? \'\' : \' invalid\' %>"><%- fd %></span><span class="tagselect-fd-separator">, </span><% }) %>';_.merge(d.prototype,{render:function(){this.el.innerHTML=this.trim(this.template(this))},postRender:function(){this.autocomplete=new k(this.el,{options:_.keys(this.options)}),this.el.addEventListener("blur",_.bind(this.update,this)),this.el.addEventListener("keydown",function(a){91===a.which||a.metaKey?a.stopPropagation():13===a.which&&(a.preventDefault(),this.blur())})},get:function(){return this.selected},set:function(a){this.selected=_.uniq(a),this.render()},setOptions:function(a){this.options=_.isArray(a)?_.invert(a):a||{},this.autocomplete&&this.autocomplete.setOptions({options:_.keys(this.options)})},update:function(){var a=_.filter(this.el.textContent.split(/\W+/)),b=!_.isEqual(a,this.selected);this.set(a),b&&this.validate()&&this.trigger("change")},validate:function(){for(var a,b=0;a=this.selected[b];b++)if(!this.options[a])return!1;return!0},trim:function(a){return a.replace(/\n\s*/gm,"")},on:function(a,b){this.listeners[a].push(b)},trigger:function(a){_.forEach(this.listeners[a],function(a){a()})}}),window.TagSelect=d}({},function(){return this}());